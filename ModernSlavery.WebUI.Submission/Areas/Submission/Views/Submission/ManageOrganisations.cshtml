@inject IReportingDeadlineHelper SnapshotDateHelper
@inject IWebService WebService
@inject IObfuscator Obfuscator
@using ModernSlavery.Core.Interfaces
@model IEnumerable<UserOrganisation>
@{
    Layout = "~/Views/GdsLayout.cshtml";
    ViewBag.Title = "Manage your organisation - Modern Slavery reporting service";
    var hasRegisteredOrgs = Model.Any();
}

@section BeforeMain {
    @await Html.PartialAsync("AccountNavigation")
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-l">
            Select an organisation
        </h1>
        <p class="govuk-body">Use this page to access your registered organisations or to register a new organisation.</p>

        <p class="govuk-body">Once you've selected an organisation (by clicking on its name, below) you can:</p>

        <ul class="govuk-list govuk-list--bullet">
            <li>state whether this organisation is required to publish an annual modern slavery statement</li>
            <li>provide a link to the full modern slavery statement published on the organisation's website</li>
            <li>enter information about this organisation's modern slavery statement</li>
            <li>save this information as a draft, and complete it at a later date before submitting it</li>
        </ul>

        <p class="govuk-body">The information you submit will be published on our viewing service as a summary of your modern slavery statement.</p>

        <table class="govuk-table" summary="A list of organisations registered to your account" style="margin-top: 30px">
            <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th class="govuk-table__header" scope="col">Organisation name</th>
                    <th scope="col" class="govuk-table__header">Registration status</th>
                </tr>
            </thead>
            <tbody class="govuk-table__body">
                @foreach (var userOrg in Model)
                {
                    // include the currrent user in the count but dont show a count to pending users
                    var assocUserCount = userOrg.GetAssociatedUsers().Count();
                    var accountingDate = SnapshotDateHelper.GetReportingStartDate(userOrg.Organisation.SectorType);

                    var encOrgId = Obfuscator.Obfuscate(userOrg.OrganisationId.ToString());
                    var latestStatement = userOrg.Organisation.LatestStatement;
                    var scopeStatus = userOrg.Organisation.GetActiveScopeStatus(accountingDate);
                    var address = userOrg.Organisation.GetLatestAddress()?.GetAddressString();

                    <tr class="govuk-table__row">
                        @if (userOrg.PINSentDate != null && userOrg.PINConfirmedDate == null)
                        {
                            <td class="govuk-table__cell" scope="row">
                                <a class="govuk-link" id="ActivateOrg-@(encOrgId)" href="@Url.ActionArea("ActivateService","Registration", "Registration", new {id = encOrgId})">
                                    <span>@userOrg.Organisation.OrganisationName.ToUpper()</span>
                                </a>
                            </td>
                            <td class="govuk-table__cell" data-prefix="Status">
                                Awaiting activation PIN
                            </td>
                        }
                        else if (userOrg.PINSentDate == null && userOrg.PINConfirmedDate == null)
                        {
                            <td class="govuk-table__cell" scope="row">
                                <span>@userOrg.Organisation.OrganisationName.ToUpper()</span>
                            </td>
                            <td class="govuk-table__cell" data-prefix="Status">
                                Awaiting registration approval
                            </td>
                        }
                        else
                        {
                            <td class="govuk-table__cell" scope="row">
                                <a class="govuk-link" id="ManageOrg-@(encOrgId)" href="@Url.Action("ManageOrganisation", "Submission", new {organisationIdentifier = encOrgId})">
                                    <span>@userOrg.Organisation.OrganisationName.ToUpper()</span>
                                </a>
                            </td>
                            <td class="govuk-table__cell" data-prefix="Status">
                                <span>Registration complete</span>
                            </td>
                        }
                    </tr>
                }

                @if (hasRegisteredOrgs == false)
                {
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell" colspan="2" style="border-bottom: none">There are no organisations registered to your account.</td>
                    </tr>
                }

            </tbody>
        </table>

    </div>

</div>

<div class="govuk-grid-row">

    <div class="govuk-grid-column-two-thirds">

        <p class="govuk-body">
            <a class="govuk-button" href="@Url.ActionArea("OrganisationType","Registration", "Registration")">Register an organisation</a>
        </p>

        @if (hasRegisteredOrgs == false)
        {
            <h2 class="govuk-heading-s">Need to close your account?</h2>
            <p class="govuk-body">
                If you created an account by mistake or no longer responsible
                for reporting Modern Slavery statement you can close your account in <a asp-action="home" asp-controller="Account" asp-area="Account">manage account</a>.
            </p>
        }

    </div>

</div>
<hr style="background: black; border: 1px solid black;" />
<partial name="~/Views/Shared/ServiceSurveyIntroAndLink.cshtml" />